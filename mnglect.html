<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Lecturer (Firestore)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6fafa; padding: 20px; }
    .header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .header h2 { margin:0; color:#000; }
    #searchInput { padding:8px 12px; width:300px; border-radius:20px; border:1px solid #ccc; transition:0.3s; }
    #searchInput:focus { outline:none; border-color:#1E3A8A; box-shadow:0 0 5px rgba(30,58,138,0.5); }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ddd; padding:12px; text-align:left; }
    thead { background:#333; color:#fff; }
    .action-button { background:#3b57c0; color:#fff; border:none; padding:6px 12px; margin-right:5px; cursor:pointer; border-radius:4px; }
    .action-button:hover { background:#2f45a0; }
    .add-button { margin-top:20px; background:#28a745; }
    .add-button:hover { background:#218838; }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
    .modal-content { background:#fff; margin:8% auto; padding:20px; width:420px; border-radius:8px; position:relative; }
    .modal-content input, .modal-content select { width:100%; padding:8px; margin:8px 0; border:1px solid #ccc; border-radius:4px; }
    .submit-btn { background:#3b57c0; color:#fff; padding:8px 14px; border:none; cursor:pointer; border-radius:4px; }
    .submit-btn:hover { background:#2f45a0; }
    .close { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; }
    #backBtn { background:#00aaff; color:#fff; border:none; padding:10px 20px; border-radius:4px; margin-bottom:10px; cursor:pointer; }
    #backBtn:hover { background:#14214e; }
  </style>
</head>
<body>
  <button id="backBtn">Go back to homepage</button>
  <div class="header">
    <h2>Manage Lecturer</h2>
    <input type="text" id="searchInput" placeholder="Search name...">
  </div>

  <table id="lecturerTable">
    <thead>
      <tr>
        <th>No.</th>
        <th>LECTURER_ID</th>
        <th>LECTURER_NAME</th>
        <th>LECTURER_EMAIL</th>
        <th>FACULTY</th>
        <th>CONTACT</th>
        <th>CREATED_BY</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="action-button add-button" id="addBtn">Add Lecturer</button>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <span class="close" id="modalClose">&times;</span>
      <h3 id="modalTitle">Add New Lecturer</h3>
      <form id="lecturerForm">
        <input type="text" id="lecturerId" placeholder="Lecturer ID" required>
        <input type="text" id="lecturerName" placeholder="Lecturer Name" required>
        <input type="email" id="lecturerEmail" placeholder="Lecturer Email" required>
        <select id="lecturerFaculty" required>
          <option value="" disabled selected>Select Faculty</option>
          <option>FCM</option>
          <option>FCA</option>
          <option>FAC</option>
          <option>FCI</option>
          <option>FOM</option>
          <option>FOE</option>
        </select>
        <input type="text" id="lecturerContact" placeholder="Contact" required>
        <input type="text" id="lecturerCreatedBy" value="AD001" readonly>
        <button type="submit" class="submit-btn">Save</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs,
      setDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Initialize Firebase
    const app = initializeApp({
      apiKey: "AIzaSyD3TSVMe8Ub-JL0y7M0VlXvPdskeOG1DaA",
      authDomain: "appointment-management-c2531.firebaseapp.com",
      projectId: "appointment-management-c2531",
    });
    const db = getFirestore(app);

    let editingDocId = null;
    const tableBody   = document.querySelector('#lecturerTable tbody');
    const addBtn      = document.getElementById('addBtn');
    const modal       = document.getElementById('addModal');
    const closeBtn    = document.getElementById('modalClose');
    const form        = document.getElementById('lecturerForm');
    const backBtn     = document.getElementById('backBtn');
    const searchInput = document.getElementById('searchInput');

    // Elements
    const idInput       = document.getElementById('lecturerId');
    const nameInput     = document.getElementById('lecturerName');
    const emailInput    = document.getElementById('lecturerEmail');
    const facultyInput  = document.getElementById('lecturerFaculty');
    const contactInput  = document.getElementById('lecturerContact');
    const createdByInput= document.getElementById('lecturerCreatedBy');

    // Cross‐collection duplicate check
    async function checkDuplicate(id, email) {
      const [adminsSnap, lectsSnap, studsSnap] = await Promise.all([
        getDocs(collection(db, 'admins')),
        getDocs(collection(db, 'lecturers')),
        getDocs(collection(db, 'students'))
      ]);
      const all = [...adminsSnap.docs, ...lectsSnap.docs, ...studsSnap.docs];
      return all.some(d => {
        const data = d.data();
        // data.id is the stored ID, d.id is Firestore doc key
        return (data.id === id || data.email === email)
            && d.id !== editingDocId;
      });
    }

    // Load existing lecturers
    async function loadLecturers() {
      const snap = await getDocs(collection(db, 'lecturers'));
      snap.forEach(docSnap => {
        const d = docSnap.data();
        addLecturerRow(d.id, d.name, d.email, d.faculty, d.contact, d.createdBy, docSnap.id);
      });
      renumberRows();
    }

    function addLecturerRow(id, name, email, faculty, contact, createdBy, key) {
      const row = tableBody.insertRow();
      row.dataset.key = key;
      row.insertCell().textContent = tableBody.rows.length;
      row.insertCell().textContent = id;
      row.insertCell().textContent = name;
      row.insertCell().textContent = email;
      row.insertCell().textContent = faculty;
      row.insertCell().textContent = contact;
      row.insertCell().textContent = createdBy;
      row.insertCell().innerHTML =
        `<button class="action-button" data-action="edit">Edit</button>` +
        `<button class="action-button" data-action="delete">Delete</button>`;
    }

    function renumberRows() {
      Array.from(tableBody.rows).forEach((r,i)=> r.cells[0].textContent = i+1);
    }

    // UI handlers
    addBtn.onclick     = ()=>{ editingDocId=null; form.reset(); openModal(false); };
    closeBtn.onclick   = closeModal;
    backBtn.onclick    = ()=>{ if(confirm('Go back to homepage?')) location='admin.html'; };
    searchInput.oninput= ()=> {
      const f = searchInput.value.toLowerCase();
      Array.from(tableBody.rows)
        .forEach(r=> r.style.display = r.cells[2].textContent.toLowerCase().includes(f)?'':'none');
    };
    window.onclick     = e=>{ if(e.target===modal) closeModal(); };

    function openModal(edit) {
      modal.style.display = 'block';
      document.getElementById('modalTitle').textContent = edit? 'Edit Lecturer':'Add New Lecturer';
    }
    function closeModal() {
      modal.style.display = 'none';
      form.reset();
    }

    // Form submit with global duplicate check
    form.onsubmit = async e => {
      e.preventDefault();
      const id      = idInput.value.trim();
      const name    = nameInput.value.trim();
      const email   = emailInput.value.trim();
      const faculty = facultyInput.value;
      const contact = contactInput.value.trim();
      const createdBy = createdByInput.value;

      // 1) cross‐collection check
      if (await checkDuplicate(id, email)) {
        alert('ID or email exists in Admins, Lecturers, or Students.');
        return;
      }

      // 2) your existing lecturer‐only duplicate check
      const lectSnap = await getDocs(collection(db, 'lecturers'));
      const dup = lectSnap.docs.some(d => {
        const dt = d.data();
        return (dt.id === id || dt.email === email)
            && d.id !== editingDocId;
      });
      if (dup) {
        alert('Duplicate in lecturers—operation denied.');
        return;
      }

      // 3) confirm & write
      if (!confirm(editingDocId? 'Confirm update?' : 'Confirm addition?')) return;
      const rec = { id,name,email,faculty,contact,createdBy,role:'lecturer' };

      try {
        if (editingDocId) {
          await updateDoc(doc(db,'lecturers',editingDocId), rec);
          // update row
          Array.from(tableBody.rows).forEach(r=>{
            if (r.dataset.key === editingDocId) {
              r.cells[1].textContent = id;
              r.cells[2].textContent = name;
              r.cells[3].textContent = email;
              r.cells[4].textContent = faculty;
              r.cells[5].textContent = contact;
              r.cells[6].textContent = createdBy;
            }
          });
        } else {
          await setDoc(doc(db,'lecturers',email), rec);
          addLecturerRow(id,name,email,faculty,contact,createdBy,email);
        }
        renumberRows();
        closeModal();
        alert('Saved successfully.');
      } catch(err) {
        console.error(err);
        alert('Firestore error: ' + err.message);
      }
    };

    // Edit/Delete delegation
    tableBody.onclick = async e => {
      const act = e.target.dataset.action;
      if (!act) return;
      const row = e.target.closest('tr');
      const key = row.dataset.key;

      if (act === 'edit') {
        editingDocId = key;
        idInput.value       = row.cells[1].textContent;
        nameInput.value     = row.cells[2].textContent;
        emailInput.value    = row.cells[3].textContent;
        facultyInput.value  = row.cells[4].textContent;
        contactInput.value  = row.cells[5].textContent;
        createdByInput.value= row.cells[6].textContent;
        openModal(true);
      }
      if (act === 'delete') {
        if (!confirm('Confirm deletion?')) return;
        try {
          await deleteDoc(doc(db,'lecturers',key));
          row.remove();
          renumberRows();
          alert('Deleted.');
        } catch(err) {
          console.error(err);
          alert('Error deleting: '+err.message);
        }
      }
    };

    // Initial load
    loadLecturers();
  </script>
</body>
</html>
