<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Student (with Faculty Dropdown)</title>
  <style>
    /* existing CSS unchanged */
    body { font-family: Arial; background: #f6fafa; padding: 20px; }
    .header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .header h2 { color:#000; margin:0; }
    #searchInput { padding:8px 12px; width:300px; border-radius:20px; border:1px solid #ccc; transition:0.3s; }
    #searchInput:focus { outline:none; border-color:#1E3A8A; box-shadow:0 0 5px rgba(30,58,138,0.5); }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ddd; padding:12px; text-align:left; }
    thead { background:#333; color:#fff; }
    .action-button { background:#3b57c0; color:#fff; border:none; padding:6px 12px; margin-right:5px; cursor:pointer; border-radius:4px; }
    .action-button:hover { background:#2f45a0; }
    .add-button { margin-top:20px; background:#28a745; }
    .add-button:hover { background:#218838; }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
    .modal-content { background:#fff; margin:8% auto; padding:20px; width:420px; border-radius:8px; position:relative; }
    .modal-content input, .modal-content select { width:100%; padding:8px; margin:8px 0; border:1px solid #ccc; border-radius:4px; }
    .submit-btn { background:#3b57c0; color:#fff; padding:8px 14px; border:none; cursor:pointer; border-radius:4px; }
    .submit-btn:hover { background:#2f45a0; }
    .close { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; }
    #backBtn { background:#00aaff; color:#fff; border:none; padding:10px 20px; border-radius:4px; margin-bottom:10px; cursor:pointer; }
    #backBtn:hover { background:#14214e; }
  </style>
</head>
<body>
  <button id="backBtn">Go back to homepage</button>

  <div class="header">
    <h2>Manage Student</h2>
    <input type="text" id="searchInput" placeholder="Search name...">
  </div>

  <table id="studentTable">
    <thead>
      <tr>
        <th>No.</th>
        <th>STUDENT_ID</th>
        <th>STUDENT_NAME</th>
        <th>STUDENT_EMAIL</th>
        <th>FACULTY</th>
        <th>COURSE</th>
        <th>CREATED_BY</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="action-button add-button" id="addBtn">Add Student</button>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <span class="close" id="modalClose">&times;</span>
      <h3 id="modalTitle">Add New Student</h3>
      <form id="studentForm">
        <input type="text" id="studentId" placeholder="Student ID" required>
        <input type="text" id="studentName" placeholder="Student Name" required>
        <input type="email" id="studentEmail" placeholder="Student Email" required>
        <!-- Faculty Dropdown -->
        <select id="studentFaculty" required>
          <option value="" disabled selected>Select Faculty</option>
          <option value="FCM">FCM</option>
          <option value="FCA">FCA</option>
          <option value="FAC">FAC</option>
          <option value="FCI">FCI</option>
          <option value="FOM">FOM</option>
          <option value="FOE">FOE</option>
        </select>
        <input type="text" id="studentCourse" placeholder="Course" required>
        <input type="text" id="studentCreatedBy" value="AD001" readonly>
        <button type="submit" class="submit-btn">Save</button>
      </form>
    </div>
  </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs,
      setDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Firebase init
    const app = initializeApp({
      apiKey: "AIzaSyD3TSVMe8Ub-JL0y7M0VlXvPdskeOG1DaA",
      authDomain: "appointment-management-c2531.firebaseapp.com",
      projectId: "appointment-management-c2531"
    });
    const db = getFirestore(app);

    let editingDocId = null;
    const tableBody   = document.querySelector('#studentTable tbody');
    const addBtn      = document.getElementById('addBtn');
    const modal       = document.getElementById('addModal');
    const closeBtn    = document.getElementById('modalClose');
    const form        = document.getElementById('studentForm');
    const backBtn     = document.getElementById('backBtn');
    const searchInput = document.getElementById('searchInput');

    // Form fields
    const idInput        = document.getElementById('studentId');
    const nameInput      = document.getElementById('studentName');
    const emailInput     = document.getElementById('studentEmail');
    const facultyInput   = document.getElementById('studentFaculty');
    const courseInput    = document.getElementById('studentCourse');
    const createdByInput = document.getElementById('studentCreatedBy');

    // Cross-collection duplicate check
    async function checkDuplicate(id, email) {
      const [adminsSnap, lectsSnap, studsSnap] = await Promise.all([
        getDocs(collection(db, 'admins')),
        getDocs(collection(db, 'lecturers')),
        getDocs(collection(db, 'students'))
      ]);
      const all = [...adminsSnap.docs, ...lectsSnap.docs, ...studsSnap.docs];
      return all.some(d => {
        const data = d.data();
        return (data.id === id || data.email === email)
            && d.id !== editingDocId;
      });
    }

    // Load students
    async function loadStudents() {
      const snap = await getDocs(collection(db, 'students'));
      snap.forEach(docSnap => {
        const d = docSnap.data();
        addStudentRow(d.id, d.name, d.email, d.faculty, d.course, d.createdBy, docSnap.id);
      });
      renumberRows();
    }

    function addStudentRow(id, name, email, faculty, course, createdBy, key) {
      const row = tableBody.insertRow();
      row.dataset.key = key;
      row.insertCell().textContent = tableBody.rows.length;
      row.insertCell().textContent = id;
      row.insertCell().textContent = name;
      row.insertCell().textContent = email;
      row.insertCell().textContent = faculty;
      row.insertCell().textContent = course;
      row.insertCell().textContent = createdBy;
      row.insertCell().innerHTML =
        `<button class="action-button" data-action="edit">Edit</button>` +
        `<button class="action-button" data-action="delete">Delete</button>`;
    }

    function renumberRows() {
      Array.from(tableBody.rows).forEach((r,i)=> r.cells[0].textContent = i+1);
    }

    // UI
    addBtn.onclick     = ()=>{ editingDocId=null; form.reset(); openModal(false); };
    closeBtn.onclick   = closeModal;
    backBtn.onclick    = ()=>{ if(confirm('Go back to homepage?')) location='admin.html'; };
    searchInput.oninput= ()=> {
      const f = searchInput.value.toLowerCase();
      Array.from(tableBody.rows)
        .forEach(r=> r.style.display = r.cells[2].textContent.toLowerCase().includes(f)?'':'none');
    };
    window.onclick     = e=>{ if(e.target===modal) closeModal(); };

    function openModal(edit) {
      modal.style.display = 'block';
      document.getElementById('modalTitle').textContent = edit? 'Edit Student':'Add New Student';
    }
    function closeModal() {
      modal.style.display = 'none';
      form.reset();
    }

    // Form submit with duplicate checks
    form.onsubmit = async e => {
      e.preventDefault();
      const id      = idInput.value.trim();
      const name    = nameInput.value.trim();
      const email   = emailInput.value.trim();
      const faculty = facultyInput.value;
      const course  = courseInput.value.trim();
      const createdBy = createdByInput.value;

      // cross-collection
      if (await checkDuplicate(id, email)) {
        alert('ID or email exists in Admins, Lecturers, or Students.');
        return;
      }
      // students-only
      const studSnap = await getDocs(collection(db, 'students'));
      const dup = studSnap.docs.some(d => {
        const dt = d.data();
        return (dt.id===id || dt.email===email) && d.id!==editingDocId;
      });
      if (dup) {
        alert('Duplicate in studentsâ€”operation denied.');
        return;
      }

      if (!confirm(editingDocId? 'Confirm update?' : 'Confirm addition?')) return;
      const rec = { id,name,email,faculty,course,createdBy,role:'student' };

      try {
        if (editingDocId) {
          await updateDoc(doc(db,'students',editingDocId), rec);
          Array.from(tableBody.rows).forEach(r=>{
            if (r.dataset.key===editingDocId) {
              r.cells[1].textContent = id;
              r.cells[2].textContent = name;
              r.cells[3].textContent = email;
              r.cells[4].textContent = faculty;
              r.cells[5].textContent = course;
              r.cells[6].textContent = createdBy;
            }
          });
        } else {
          await setDoc(doc(db,'students',email), rec);
          addStudentRow(id,name,email,faculty,course,createdBy,email);
        }
        renumberRows();
        closeModal();
        alert('Saved successfully.');
      } catch(err) {
        console.error(err);
        alert('Firestore error: '+err.message);
      }
    };

    // Edit / delete delegation
    tableBody.onclick = async e => {
      const act = e.target.dataset.action;
      if (!act) return;
      const row = e.target.closest('tr');
      const key = row.dataset.key;

      if (act==='edit') {
        editingDocId = key;
        idInput.value        = row.cells[1].textContent;
        nameInput.value      = row.cells[2].textContent;
        emailInput.value     = row.cells[3].textContent;
        facultyInput.value   = row.cells[4].textContent;
        courseInput.value    = row.cells[5].textContent;
        createdByInput.value = row.cells[6].textContent;
        openModal(true);
      }
      if (act==='delete') {
        if (!confirm('Confirm deletion?')) return;
        try {
          await deleteDoc(doc(db,'students',key));
          row.remove();
          renumberRows();
          alert('Deleted.');
        } catch(err) {
          console.error(err);
          alert('Error deleting: '+err.message);
        }
      }
    };

    // initial
    loadStudents();
  </script>
</body>
</html>
